<!DOCTYPE html>

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
<!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>2020/01/13-19 weekly review | SingularityKChen</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="2020/01/13-19 weekly review" />
<meta name="author" content="SingularityKChen" />
<meta property="og:locale" content="en" />
<meta name="description" content="the weekly review from 2020/01/13 to 19" />
<meta property="og:description" content="the weekly review from 2020/01/13 to 19" />
<link rel="canonical" href="http://localhost:4000/blog/2020/01/19/2020-01-13-19-weekly-review/" />
<meta property="og:url" content="http://localhost:4000/blog/2020/01/19/2020-01-13-19-weekly-review/" />
<meta property="og:site_name" content="SingularityKChen" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-19T00:00:00+08:00" />
<script type="application/ld+json">
{"dateModified":"2020-01-19T00:00:00+08:00","datePublished":"2020-01-19T00:00:00+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2020/01/19/2020-01-13-19-weekly-review/"},"url":"http://localhost:4000/blog/2020/01/19/2020-01-13-19-weekly-review/","author":{"@type":"Person","name":"SingularityKChen"},"description":"the weekly review from 2020/01/13 to 19","headline":"2020/01/13-19 weekly review","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<meta name="keywords" content="WeeklyReview,EyerissV2,HM-NoC,Chisel" />





<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="SingularityKChen" />
    <link href='/assets/stylesheets/blog.css' rel="stylesheet" type="text/css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script>window.Modernizr || document.write('<script src="/assets/javascripts/modernizr-2.8.3.min.js"><\/script>')</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="/assets/javascripts/jquery-3.3.1.min.js"><\/script>')
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script>
    window.Pace || document.write('<script src="/assets/javascripts/pace.min.js"><\/script>')
</script>

    
</head>

<body>
    

    <!--[if IE]>
    <p class="site-notice">You are using an outdated browser. Please <a href="http://browsehappy.com/" target="_blank">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true" target="_blank">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->
<noscript>
    <p class="site-notice">This site requires JavaScript. Here are the instructions <a href="http://www.enable-javascript.com/" target="_blank">how to enable JavaScript in your web browser</a>.</p>
</noscript>

    <div class="nav-wrapper overlay-wrapper">
    <div class="nav-form overlay-form">
        <span class="overlay-header menu">Menu</span>
        <a class="btn-close">Close</a>
        <div class="results">
            <ul>
                <li><a href="/blog/categories/">Categories</a></li>
                <li><a href="/blog/tags/">Tags</a></li>
                <li><a href="/">About</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="search-wrapper overlay-wrapper">
    <div class="search-form overlay-form">
        <input type="text" class="overlay-header search-field" placeholder="Search...">
        <a class="btn-close">Close</a>
        <ul class="results"></ul>
    </div>
</div>


    <div id="page" class="hentry">
        <header class="the-header">
    <div class="unit-head">
        <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
                <ul>
                    <li class="logo nav-link">
                        <button class="btn-menu" title="Menu"></button>
                        <a href="/blog/">SingularityKChen's Blog</a>
                        <span style="opacity: 0.6;">/<small><a href="https://github.com/SingularityKChen?tab=repositories">Projects</a></small></span>
                    </li>
                    <li class="nav-link"><a title="Categories" href="/blog/categories/">Categories</a></li>
                    <li class="nav-link"><a title="Tags" href="/blog/tags/">Tags</a></li>
                    <!--[if !IE]> -->
                    <li class="nav-link"><a title="Search" class="btn-search" href="#">Search</a></li>
                    <!-- <![endif]-->
                </ul>
            </nav>
        </div>
    </div>
</header>


        <div class="body animated fadeInDown" role="main">
            <div class="unit-body">
                <div class="unit-inner unit-body-inner">
                    <div class="entry-content">
                        <article class="unit-article layout-post">
    <div class="unit-inner unit-article-inner">
        <div itemscope itemtype="http://schema.org/Article" class="content">
            <header>
                <div class="unit-head">
                    <div class="unit-inner unit-head-inner">
                        <h1 class="entry-title" itemprop="name">2020/01/13-19 weekly review</h1>
                    </div>
                </div>
            </header>
            <div class="bd article-content">
                <div class="entry-content">
                    <div class="meta">
                        <p class="date-publish">
                            Published:
                            <time itemprop="datePublished" class="date-pub updated"
                                title="2020-01-19T00:00:00+08:00" datetime="2020-01-19T00:00:00+08:00">January 19, 2020 </time>
                            by
                            <a class="author" href="/" rel="author" title="Show Author">
                                <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                                    <span itemprop="name">SingularityKChen</span>
                                </span>
                            </a>
                            
                                <a class="license-icon" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" title="Show License">
                                    <img alt="Creative Commons Licence" style="border-width:0" src="/assets/images/theme/cc-by-sa.png"  height="16" width="80"/>
                                </a>
                            
                            
                        </p>
                        <ul class="list-category list-linear">
                            <li class="list-head">Categories: </li>
                             
     
        <li>
            <a href="/blog/categories/#WeeklyReview" title="WeeklyReview">
            WeeklyReview <span>8</span></a>
        </li>
    



                        </ul>
                        <ul class="list-tag list-linear">
                            <li class="list-head">Tags: </li>
                             
    
        
        <li>
            <a href="/blog/tags/#Chisel" title="Chisel">Chisel <span>2</span></a>
        </li>
    
        
        <li>
            <a href="/blog/tags/#EyerissV2" title="EyerissV2">EyerissV2 <span>2</span></a>
        </li>
    
        
        <li>
            <a href="/blog/tags/#HM-NoC" title="HM-NoC">HM-NoC <span>1</span></a>
        </li>
    
        
        <li>
            <a href="/blog/tags/#WeeklyReview" title="WeeklyReview">WeeklyReview <span>8</span></a>
        </li>
    




                        </ul>
                    </div>
                    <div itemprop="articleBody">
                        <ul class="toc" id="markdown-toc">
  <li><a href="#heading-20200113-19" id="markdown-toc-heading-20200113-19">2020/01/13-19</a>    <ul>
      <li><a href="#heading-eyeriss-v2-a-flexible-accelerator-for-emerging-deep-neural-networks-on-mobile-devices" id="markdown-toc-heading-eyeriss-v2-a-flexible-accelerator-for-emerging-deep-neural-networks-on-mobile-devices">Eyeriss v2: A Flexible Accelerator for Emerging Deep Neural Networks on Mobile Devices</a>        <ul>
          <li><a href="#heading-hierarchical-architecture-of-eyeriss" id="markdown-toc-heading-hierarchical-architecture-of-eyeriss">Hierarchical Architecture of Eyeriss</a></li>
        </ul>
      </li>
      <li><a href="#heading-chisel-syntax" id="markdown-toc-heading-chisel-syntax">Chisel Syntax</a>        <ul>
          <li><a href="#heading-mac-module-delay" id="markdown-toc-heading-mac-module-delay">MAC module Delay</a></li>
          <li><a href="#heading-mem-read-test" id="markdown-toc-heading-mem-read-test">MEM Read Test</a></li>
          <li><a href="#heading-reading-after-reading-from-another-mem" id="markdown-toc-heading-reading-after-reading-from-another-mem">Reading After Reading From Another Mem</a></li>
          <li><a href="#heading-read-part-of-uint" id="markdown-toc-heading-read-part-of-uint">Read Part of <code class="language-plaintext highlighter-rouge">UInt</code></a></li>
          <li><a href="#heading-combine-two-integers-as-bits" id="markdown-toc-heading-combine-two-integers-as-bits">Combine Two Integers as Bits</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<h1 id="heading-20200113-19">2020/01/13-19</h1>

<p>This week I read <a href="#eyeriss-v2-a-flexible-accelerator-for-emerging-deep-neural-networks-on-mobile-devices">another paper of Eyeriss v2</a> and found the new PE architecture it uses. So I changed the design to fit this new one. And because of the complexity of CSC coding format it uses, I spent almost two days to work out the read control logic of CSC hence no time for the software analysis system. And today I thought out a more hardware-friendly CSC format, and I will work on it. Currently, this PE project has passed two basic reads and write tests.</p>

<p>Next week, I have to finish the PE with a test file, and then try to establish the software analysis system.</p>

<hr />

<h2 id="heading-eyeriss-v2-a-flexible-accelerator-for-emerging-deep-neural-networks-on-mobile-devices">Eyeriss v2: A Flexible Accelerator for Emerging Deep Neural Networks on Mobile Devices</h2>

<h3 id="heading-hierarchical-architecture-of-eyeriss">Hierarchical Architecture of Eyeriss</h3>

<h4 id="heading-top-level">Top Level</h4>

<p>The PEs and GLBs are grouped into clusters to support a flexible on-chip network (NoC) that connects the GLBs to the PEs at low cost.</p>

<p><img src="https://images-cdn.shimo.im/GfZZt2o1Omo0Px4X/image.png" alt="Eyeriss v2 top-level architecture" /></p>

<p><img src="https://images-cdn.shimo.im/rdHBVt49L3Ukg9eb/image.png" alt="the components in the architecture" /></p>

<h4 id="heading-hierarchical-mesh-network-hm-noc">Hierarchical Mesh Network (HM-NoC)</h4>

<p>The HM-NoC can be configured into four different modes depending on the data reuse opportunity and bandwidth requirements.</p>

<ul>
  <li>In the high bandwidth mode, each GLB bank or off-chip data I/O can deliver data independently to the PEs in the cluster, which achieves unicast.</li>
  <li>In the high reuse mode, data from the same source can be routed to all PEs in different clusters, which achieves broadcast.</li>
  <li>For situations where the data reuse cannot fully utilize the entire PE array with broadcast, different multicast modes, specifically grouped-multicast and interleaved multicast, can be adapted according to the desired multicast patterns.</li>
</ul>

<p><img src="https://images-cdn.shimo.im/2eS389Ug4u84Mujp/image.png" alt="Hierarchical mesh network for input activations. This only shows the top 2×2 of the entire 8×2 cluster array" /></p>

<p><img src="https://images-cdn.shimo.im/CWvcp5kSbPMpEQEx/image.png" alt="Hierarchical mesh network for weights. This only shows the top 2×2 of the entire 8×2 cluster array" /></p>

<p><img src="https://images-cdn.shimo.im/HdYFi0MzVIgkyYm0/image.png" alt="Hierarchical mesh network for psums. This only shows a 2×2 portion of the entire 8×2 cluster array" /></p>

<p>HM-NoC adapts different modes for different types of layers:</p>

<ul>
  <li>Conventional CONV layers: In normal CONV layers, there is plenty of data reuse for both iacts and weights. To keep all 4 PEs busy at the lowest bandwidth requirement, we need 2 iacts and 2 weights from the data source (ignoring the reuse from SPad). In this case, either the HM-NoC for iact or weight has to be configured into the grouped-multicast mode, while the other one configured into the interleaved-multicast mode.</li>
  <li>Depth-wise (DP) CONV layers: For DP CONV layers, there can be nearly no reuse for iacts due to the lack of output channels. Therefore, we can only exploit the reuse of weights by broadcasting the weights to all PEs while fetching unique iacts for each PE.</li>
  <li>Fully-connected (FC) layers: Contrary to the DP CONV layers, FC layers usually see little reuse for weights, especially when the batch size is limited. In this case, the modes of iact and weight NoCs are swapped from the previous one: the weights are now unicast to the PEs while the iacts are broadcast to all PEs.</li>
</ul>

<h4 id="heading-eyeriss-v2-pe-architecture">Eyeriss v2 PE Architecture</h4>

<p>To handle these dependencies while still maintaining throughput, the PE is implemented using seven pipeline stages and five SPads:</p>

<ul>
  <li>
    <p>The first two pipeline stages are responsible for fetching non-zero iacts from the SPads.</p>
  </li>
  <li>After a non-zero iact is fetched, the next three pipeline stages read the corresponding weights.</li>
  <li>The final two stages in the pipeline perform the MAC computation on the fetched non-zero iact and weight and then send the updated psum either back to the psum SPad or out of the PE.</li>
  <li>The iact address SPad stores the address vector of the CSC compressed iacts, which is used to address the reads from the iact data SPad that holds the non-zero data vector as well as the count vector.</li>
  <li>There is a weight address SPad to address the reads from the weight data SPad for the correct column of weights.</li>
  <li>There is a psum SPad</li>
</ul>

<p><img src="https://images-cdn.shimo.im/Zj7Aa6YzIis6Fhxs/image.png" alt="Eyeriss v2 PE Architecture. The address SPad for both iact and weight are used to store address vector in the CSC compressed data, while the data SPad stores the data and count vectors" /></p>

<p>And this is the data format this architecture uses. But I will use a more simple one.</p>

<p><img src="https://images-cdn.shimo.im/dwf3TL2QC4EdrmXJ/image.png" alt="Example of compressing sparse weights with compressed sparse column (CSC) coding" /></p>

<table>
  <thead>
    <tr>
      <th>data</th>
      <th>row</th>
      <th>col</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>a</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <td>b</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <td>c</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>d</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>e</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <td>f</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <td>g</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <td>h</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <td>i</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <td>j</td>
      <td>0</td>
      <td>7</td>
    </tr>
    <tr>
      <td>k</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <td>l</td>
      <td>2</td>
      <td>7</td>
    </tr>
  </tbody>
</table>

<h2 id="heading-chisel-syntax">Chisel Syntax</h2>

<h3 id="heading-mac-module-delay">MAC module Delay</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TheMACModule</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
		<span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">a</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">b</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">c</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">out_reg0</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">out_reg1</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">out_reg2</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
		<span class="o">})</span>

				<span class="k">val</span> <span class="nv">a_reg</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">b_reg</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="n">a_reg</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">a</span> <span class="o">*</span> <span class="nv">io</span><span class="o">.</span><span class="py">b</span>
				<span class="n">b_reg</span> <span class="o">:=</span> <span class="n">a_reg</span> <span class="o">+</span> <span class="nv">io</span><span class="o">.</span><span class="py">c</span>
		
				<span class="nv">io</span><span class="o">.</span><span class="py">out_reg0</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">a</span> <span class="o">*</span> <span class="nv">io</span><span class="o">.</span><span class="py">b</span> <span class="o">+</span> <span class="nv">io</span><span class="o">.</span><span class="py">c</span>
				<span class="nv">io</span><span class="o">.</span><span class="py">out_reg1</span> <span class="o">:=</span> <span class="n">a_reg</span> <span class="o">+</span> <span class="nv">io</span><span class="o">.</span><span class="py">c</span>
				<span class="nv">io</span><span class="o">.</span><span class="py">out_reg2</span> <span class="o">:=</span> <span class="n">b_reg</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">TheMACModule</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PeekPokeTester</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">in_a</span> <span class="k">=</span> <span class="mi">2</span>
				<span class="k">val</span> <span class="nv">in_b</span> <span class="k">=</span> <span class="mi">3</span>
				<span class="k">val</span> <span class="nv">in_c</span> <span class="k">=</span> <span class="mi">4</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">a</span><span class="o">,</span> <span class="n">in_a</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">b</span><span class="o">,</span> <span class="n">in_b</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">c</span><span class="o">,</span> <span class="n">in_c</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"clock 0, out_reg0 = ${peek(c.io.out_reg0)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg1 = ${peek(c.io.out_reg1)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg2 = ${peek(c.io.out_reg2)}"</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"clock 1, out_reg0 = ${peek(c.io.out_reg0)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg1 = ${peek(c.io.out_reg1)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg2 = ${peek(c.io.out_reg2)}"</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"clock 2, out_reg0 = ${peek(c.io.out_reg0)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg1 = ${peek(c.io.out_reg1)}"</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"         out_reg2 = ${peek(c.io.out_reg2)}"</span><span class="o">)</span>
<span class="o">}</span>
<span class="nf">assert</span><span class="o">(</span><span class="nc">Driver</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">TheMACModule</span><span class="o">)</span> <span class="o">{</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="o">)})</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] [0.007] clock 0, out_reg0 = 10 // without pipe
[info] [0.007]          out_reg1 = 4
[info] [0.008]          out_reg2 = 0
[info] [0.009] clock 1, out_reg0 = 10
[info] [0.010]          out_reg1 = 10 // two stages pipe
[info] [0.010]          out_reg2 = 4
[info] [0.012] clock 2, out_reg0 = 10
[info] [0.012]          out_reg1 = 10
[info] [0.013]          out_reg2 = 10 // three stages pipe
</code></pre></div></div>

<h3 id="heading-mem-read-test">MEM Read Test</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TheMACModule</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
		<span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">r_or_w</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
				<span class="k">val</span> <span class="nv">rst</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
				<span class="c1">//val r_after_w  = Input(Bool())
</span>				<span class="k">val</span> <span class="nv">in_vec</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
				<span class="k">val</span> <span class="nv">out_vec</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
		<span class="o">})</span>

				<span class="cm">/*val a_reg = RegInit(0.U(4.W))
				val b_reg = RegInit(0.U(4.W))*/</span>
				<span class="k">val</span> <span class="nv">sram_te</span> <span class="k">=</span> <span class="nc">SyncReadMem</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">mem_te</span> <span class="k">=</span> <span class="nc">Mem</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">reg_te</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="nc">VecInit</span><span class="o">(</span><span class="nv">Seq</span><span class="o">.</span><span class="py">fill</span><span class="o">(</span><span class="mi">3</span><span class="o">)(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))))</span>
				<span class="k">val</span> <span class="nv">wire_vec</span> <span class="k">=</span> <span class="nc">Wire</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="nf">sram_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span>
								<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span> <span class="o">:=</span> <span class="nf">mem_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span>
								<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="o">)</span> <span class="o">:=</span> <span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span>
				<span class="o">}</span>
				
				<span class="nf">when</span> <span class="o">(!</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
												<span class="nv">sram_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
												<span class="nv">mem_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
												<span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
								<span class="o">}</span>
				<span class="o">}</span>
				<span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">rst</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
												<span class="nv">sram_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
												<span class="nv">mem_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
												<span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span>
								<span class="o">}</span>
				<span class="o">}</span>
				<span class="nv">io</span><span class="o">.</span><span class="py">out_vec</span> <span class="o">&lt;&gt;</span> <span class="n">wire_vec</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">TheMACModule</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PeekPokeTester</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">in_a</span> <span class="k">=</span> <span class="mi">2</span>
				<span class="k">val</span> <span class="nv">in_b</span> <span class="k">=</span> <span class="mi">3</span>
				<span class="k">val</span> <span class="nv">in_c</span> <span class="k">=</span> <span class="mi">4</span>
				<span class="k">def</span> <span class="nf">print_out</span><span class="o">(</span><span class="n">cyclen</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="o">{</span>
								<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"------- cycle ${cyclen} ---------"</span><span class="o">)</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">9</span><span class="o">)</span> <span class="o">{</span>
												<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"    out_vec(${i}) = ${peek(c.io.out_vec(i))}"</span><span class="o">)</span>
								<span class="o">}</span>
								<span class="nv">true</span><span class="o">.</span><span class="py">B</span>
				<span class="o">}</span>
				
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">rst</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span> <span class="c1">// reset the memory
</span>				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="s">"------ write begin ------"</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">rst</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				<span class="c1">//poke(c.io.r_after_w, false.B)
</span>				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">in_a</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">in_b</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">in_c</span><span class="o">)</span>
				
				<span class="nf">print_out</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">print_out</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="s">"------ read begin -------"</span><span class="o">)</span>
				
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">print_out</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">)</span>
								<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="o">}</span>
				
<span class="o">}</span>
<span class="nf">assert</span><span class="o">(</span><span class="nc">Driver</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">TheMACModule</span><span class="o">)</span> <span class="o">{</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="o">)})</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] [0.003] ------ write begin ------
[info] [0.003] ------- cycle 1 ---------
[info] [0.007]     out_vec(0) = 0
[info] [0.008]     out_vec(1) = 0
[info] [0.008]     out_vec(2) = 0
[info] [0.008]     out_vec(3) = 0
[info] [0.009]     out_vec(4) = 0
[info] [0.009]     out_vec(5) = 0
[info] [0.009]     out_vec(6) = 0
[info] [0.009]     out_vec(7) = 0
[info] [0.010]     out_vec(8) = 0
[info] [0.012] ------ read begin -------
[info] [0.013] ------- cycle 2 ---------
[info] [0.015]     out_vec(0) = 0
[info] [0.016]     out_vec(1) = 0
[info] [0.016]     out_vec(2) = 0
[info] [0.018]     out_vec(3) = 2 // Mem can read
[info] [0.018]     out_vec(4) = 3 // with a cycle
[info] [0.018]     out_vec(5) = 4
[info] [0.018]     out_vec(6) = 2 // Reg file is
[info] [0.018]     out_vec(7) = 3 // the same as
[info] [0.018]     out_vec(8) = 4 // Mem
[info] [0.020] ------- cycle 3 ---------
[info] [0.020]     out_vec(0) = 2 // Sram has to
[info] [0.020]     out_vec(1) = 3 // wait a cycle
[info] [0.020]     out_vec(2) = 4
[info] [0.020]     out_vec(3) = 2
[info] [0.020]     out_vec(4) = 3
[info] [0.020]     out_vec(5) = 4
[info] [0.020]     out_vec(6) = 2
[info] [0.020]     out_vec(7) = 3
[info] [0.020]     out_vec(8) = 4
</code></pre></div></div>

<p>So We'd better use a <code class="language-plaintext highlighter-rouge">Mux</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
				<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">sram_te</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
				<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nf">mem_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
				<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
<span class="o">}</span>

<span class="nf">when</span> <span class="o">(!</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">)</span> <span class="o">{</span>
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
								<span class="nv">sram_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
								<span class="nv">mem_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
								<span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
				<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] [0.002] ------ write begin ------
[info] [0.003] ------- cycle 1 ---------
[info] [0.004]     out_vec(0) = 0
[info] [0.004]     out_vec(1) = 0
[info] [0.004]     out_vec(2) = 0
[info] [0.004]     out_vec(3) = 0
[info] [0.004]     out_vec(4) = 0
[info] [0.005]     out_vec(5) = 0
[info] [0.005]     out_vec(6) = 0
[info] [0.005]     out_vec(7) = 0
[info] [0.005]     out_vec(8) = 0
[info] [0.005] ------- cycle 2 ---------
[info] [0.006]     out_vec(0) = 0
[info] [0.006]     out_vec(1) = 0
[info] [0.006]     out_vec(2) = 0
[info] [0.006]     out_vec(3) = 0
[info] [0.006]     out_vec(4) = 0
[info] [0.006]     out_vec(5) = 0
[info] [0.006]     out_vec(6) = 0
[info] [0.006]     out_vec(7) = 0
[info] [0.006]     out_vec(8) = 0
[info] [0.010] ------- cycle 3 ---------
[info] [0.013]     out_vec(0) = 0
[info] [0.016]     out_vec(1) = 0
[info] [0.028]     out_vec(2) = 0
[info] [0.040]     out_vec(3) = 0
[info] [0.045]     out_vec(4) = 0
[info] [0.047]     out_vec(5) = 0
[info] [0.052]     out_vec(6) = 0
[info] [0.054]     out_vec(7) = 0
[info] [0.056]     out_vec(8) = 0
[info] [0.059] ------ read begin -------
[info] [0.060] ------- cycle 4 ---------
[info] [0.062]     out_vec(0) = 14
[info] [0.063]     out_vec(1) = 7
[info] [0.070]     out_vec(2) = 9
[info] [0.080]     out_vec(3) = 2
[info] [0.086]     out_vec(4) = 3
[info] [0.087]     out_vec(5) = 4
[info] [0.088]     out_vec(6) = 2
[info] [0.090]     out_vec(7) = 3
[info] [0.095]     out_vec(8) = 4
[info] [0.099] ------- cycle 5 ---------
[info] [0.102]     out_vec(0) = 2
[info] [0.108]     out_vec(1) = 3
[info] [0.108]     out_vec(2) = 4
[info] [0.111]     out_vec(3) = 2
[info] [0.113]     out_vec(4) = 3
[info] [0.114]     out_vec(5) = 4
[info] [0.120]     out_vec(6) = 2
[info] [0.121]     out_vec(7) = 3
[info] [0.127]     out_vec(8) = 4
</code></pre></div></div>

<h3 id="heading-reading-after-reading-from-another-mem">Reading After Reading From Another Mem</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TheMACModule</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
		<span class="k">val</span> <span class="nv">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">r_or_w</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
				<span class="k">val</span> <span class="nv">rst</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
				<span class="k">val</span> <span class="nv">in_vec</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
				<span class="k">val</span> <span class="nv">out_vec</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
		<span class="o">})</span>

				<span class="k">val</span> <span class="nv">sram_te</span> <span class="k">=</span> <span class="nc">SyncReadMem</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
				<span class="k">val</span> <span class="nv">reg_te</span> <span class="k">=</span> <span class="nc">RegInit</span><span class="o">(</span><span class="nc">VecInit</span><span class="o">(</span><span class="nv">Seq</span><span class="o">.</span><span class="py">fill</span><span class="o">(</span><span class="mi">3</span><span class="o">)(</span><span class="mf">0.</span><span class="nf">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))))</span>
				<span class="k">val</span> <span class="nv">wire_vec</span> <span class="k">=</span> <span class="nc">Wire</span><span class="o">(</span><span class="nc">Vec</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)))</span>
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">sram_te</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
								<span class="c1">//wire_vec(i) := Mux(false.B, sram_te.read(wire_vec(i+3)), 0.U)
</span>								<span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nf">reg_te</span><span class="o">((</span><span class="n">i</span><span class="o">).</span><span class="py">U</span><span class="o">),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
				<span class="o">}</span>
				
				<span class="nf">when</span> <span class="o">(!</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
												<span class="nv">sram_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
												<span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span> <span class="o">:=</span> <span class="nv">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span>
								<span class="o">}</span>
				<span class="o">}</span>
				<span class="nf">when</span> <span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">rst</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
												<span class="nv">sram_te</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">,</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
												<span class="nf">reg_te</span><span class="o">(</span><span class="nv">i</span><span class="o">.</span><span class="py">U</span><span class="o">)</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span>
								<span class="o">}</span>
				<span class="o">}</span>
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
								<span class="nv">io</span><span class="o">.</span><span class="py">out_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
				<span class="o">}</span>
				
<span class="o">}</span>
<span class="k">class</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">TheMACModule</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PeekPokeTester</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">val</span> <span class="nv">in_a</span> <span class="k">=</span> <span class="mi">0</span>
				<span class="k">val</span> <span class="nv">in_b</span> <span class="k">=</span> <span class="mi">1</span>
				<span class="k">val</span> <span class="nv">in_c</span> <span class="k">=</span> <span class="mi">2</span>
				
				<span class="k">val</span> <span class="nv">in_d</span> <span class="k">=</span> <span class="mi">5</span>
				<span class="k">val</span> <span class="nv">in_e</span> <span class="k">=</span> <span class="mi">7</span>
				<span class="k">val</span> <span class="nv">in_f</span> <span class="k">=</span> <span class="mi">9</span>
				<span class="k">def</span> <span class="nf">print_out</span><span class="o">(</span><span class="n">cyclen</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="o">{</span>
								<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"------- cycle ${cyclen} ---------"</span><span class="o">)</span>
								<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
												<span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"    out_vec(${i}) = ${peek(c.io.out_vec(i))}"</span><span class="o">)</span>
								<span class="o">}</span>
								<span class="nv">true</span><span class="o">.</span><span class="py">B</span>
				<span class="o">}</span>
				
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">rst</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="s">"------ write begin ------"</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">rst</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">in_d</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">in_e</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">in_f</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">in_a</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span> <span class="n">in_b</span><span class="o">)</span>
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">in_vec</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">in_c</span><span class="o">)</span>
				
				<span class="nf">print_out</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">print_out</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">print_out</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
				<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="nf">println</span><span class="o">(</span><span class="s">"------ read begin -------"</span><span class="o">)</span>
				
				<span class="nf">poke</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
				
				<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
								<span class="nf">print_out</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span>
								<span class="nf">step</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
				<span class="o">}</span>
				
<span class="o">}</span>
<span class="nf">assert</span><span class="o">(</span><span class="nc">Driver</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">TheMACModule</span><span class="o">)</span> <span class="o">{</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">MyMACTester</span><span class="o">(</span><span class="n">c</span><span class="o">)})</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] [0.001] ------ write begin ------
[info] [0.001] ------- cycle 1 ---------
[info] [0.002]     out_vec(0) = 0
[info] [0.002]     out_vec(1) = 0
[info] [0.002]     out_vec(2) = 0
[info] [0.003]     out_vec(3) = 0
[info] [0.003]     out_vec(4) = 0
[info] [0.003]     out_vec(5) = 0
[info] [0.003] ------- cycle 2 ---------
[info] [0.003]     out_vec(0) = 0
[info] [0.004]     out_vec(1) = 0
[info] [0.004]     out_vec(2) = 0
[info] [0.004]     out_vec(3) = 0
[info] [0.004]     out_vec(4) = 0
[info] [0.004]     out_vec(5) = 0
[info] [0.004] ------- cycle 3 ---------
[info] [0.004]     out_vec(0) = 0
[info] [0.004]     out_vec(1) = 0
[info] [0.005]     out_vec(2) = 0
[info] [0.005]     out_vec(3) = 0
[info] [0.005]     out_vec(4) = 0
[info] [0.009]     out_vec(5) = 0
[info] [0.018] ------ read begin -------
[info] [0.018] ------- cycle 4 ---------
[info] [0.021]     out_vec(0) = 5
[info] [0.022]     out_vec(1) = 5
[info] [0.023]     out_vec(2) = 5
[info] [0.024]     out_vec(3) = 0 // get address
[info] [0.026]     out_vec(4) = 1
[info] [0.034]     out_vec(5) = 2
[info] [0.036] ------- cycle 5 ---------
[info] [0.036]     out_vec(0) = 5 // get the data
[info] [0.037]     out_vec(1) = 7
[info] [0.037]     out_vec(2) = 9
[info] [0.038]     out_vec(3) = 0
[info] [0.039]     out_vec(4) = 1
[info] [0.044]     out_vec(5) = 2
</code></pre></div></div>

<p>If we use <code class="language-plaintext highlighter-rouge">RegNext</code> in <code class="language-plaintext highlighter-rouge">Mux</code> for SRAM read, then it will be better:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Mux</span><span class="o">(</span><span class="nc">RegNext</span><span class="o">(</span><span class="nv">io</span><span class="o">.</span><span class="py">r_or_w</span><span class="o">),</span> <span class="nv">sram_te</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="nf">wire_vec</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="o">)),</span> <span class="mf">0.</span><span class="n">U</span><span class="o">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] [0.045] ------ read begin -------
[info] [0.049] ------- cycle 4 ---------
[info] [0.050]     out_vec(0) = 0
[info] [0.050]     out_vec(1) = 0
[info] [0.050]     out_vec(2) = 0
[info] [0.051]     out_vec(3) = 2
[info] [0.055]     out_vec(4) = 1
[info] [0.055]     out_vec(5) = 0
[info] [0.057] ------- cycle 5 ---------
[info] [0.057]     out_vec(0) = 9
[info] [0.058]     out_vec(1) = 7
[info] [0.059]     out_vec(2) = 5
[info] [0.059]     out_vec(3) = 2
[info] [0.060]     out_vec(4) = 1
[info] [0.069]     out_vec(5) = 0
</code></pre></div></div>

<p><strong>But it is not friendly to data write!</strong></p>

<h3 id="heading-read-part-of-uint">Read Part of <code class="language-plaintext highlighter-rouge">UInt</code></h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="c1">// Example
</span>		<span class="k">val</span> <span class="nv">uint</span> <span class="k">=</span> <span class="mh">0xc</span><span class="o">.</span><span class="py">U</span>
		<span class="k">val</span> <span class="nv">vec</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="nv">uint</span><span class="o">.</span><span class="py">toBools</span><span class="o">)</span>
		<span class="nf">printf</span><span class="o">(</span><span class="n">p</span><span class="s">"$vec"</span><span class="o">)</span> <span class="c1">// Vec(0, 0, 1, 1)
</span>
		<span class="c1">// Test
</span>		<span class="nf">assert</span><span class="o">(</span><span class="nf">vec</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">===</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
		<span class="nf">assert</span><span class="o">(</span><span class="nf">vec</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">===</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
		<span class="nf">assert</span><span class="o">(</span><span class="nf">vec</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">===</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
		<span class="nf">assert</span><span class="o">(</span><span class="nf">vec</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">===</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>

		<span class="c1">// Example
</span>		<span class="k">val</span> <span class="nv">vec</span> <span class="k">=</span> <span class="nc">Vec</span><span class="o">(</span><span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">,</span> <span class="nv">false</span><span class="o">.</span><span class="py">B</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">,</span> <span class="nv">true</span><span class="o">.</span><span class="py">B</span><span class="o">)</span>
		<span class="k">val</span> <span class="nv">uint</span> <span class="k">=</span> <span class="nv">vec</span><span class="o">.</span><span class="py">asUInt</span>
		<span class="nf">printf</span><span class="o">(</span><span class="n">p</span><span class="s">"$uint"</span><span class="o">)</span> <span class="c1">// 13
</span>		
		<span class="cm">/* Test
		 *
		 * (remember leftmost Bool in Vec is low order bit)
		 */</span>
		<span class="nf">assert</span><span class="o">(</span><span class="mh">0xd</span><span class="o">.</span><span class="py">U</span> <span class="o">===</span> <span class="n">uint</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">iactDataCountVec</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Bool</span><span class="o">]</span> <span class="k">=</span> <span class="nv">iactDataSPad</span><span class="o">.</span><span class="py">io</span><span class="o">.</span><span class="py">commonIO</span><span class="o">.</span><span class="py">readOutData</span><span class="o">.</span><span class="py">toBools</span>
				<span class="nv">io</span><span class="o">.</span><span class="py">iactMatrixData</span> <span class="o">:=</span> <span class="nc">Cat</span><span class="o">(</span><span class="nv">iactDataCountVec</span><span class="o">.</span><span class="py">take</span><span class="o">(</span><span class="mi">8</span><span class="o">)).</span><span class="py">asUInt</span>
				<span class="nv">io</span><span class="o">.</span><span class="py">iactMatrixRow</span> <span class="o">:=</span> <span class="nc">Cat</span><span class="o">(</span><span class="nv">iactDataCountVec</span><span class="o">.</span><span class="py">takeRight</span><span class="o">(</span><span class="mi">4</span><span class="o">)).</span><span class="py">asUInt</span>
</code></pre></div></div>

<h3 id="heading-combine-two-integers-as-bits">Combine Two Integers as Bits</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">inDataWithIndex</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">14</span><span class="o">,</span> <span class="mi">16</span><span class="o">,</span> <span class="mi">18</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mi">22</span><span class="o">).</span><span class="py">zipWithIndex</span>
<span class="k">def</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">digits</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span> <span class="k">=</span>
		 <span class="nv">String</span><span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="s">"%"</span> <span class="o">+</span> <span class="n">digits</span> <span class="o">+</span> <span class="s">"s"</span><span class="o">,</span> <span class="nv">i</span><span class="o">.</span><span class="py">toBinaryString</span><span class="o">).</span><span class="py">replace</span><span class="o">(</span><span class="sc">' '</span><span class="o">,</span> <span class="sc">'0'</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">inDataCountBinary</span> <span class="k">=</span> <span class="nv">inDataWithIndex</span><span class="o">.</span><span class="py">map</span><span class="o">{</span><span class="nf">case</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">8</span><span class="o">)</span> <span class="o">+</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="mi">4</span><span class="o">)}</span>
<span class="k">val</span> <span class="nv">inDataCountDec</span> <span class="k">=</span> <span class="nv">inDataCountBinary</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">parseInt</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
<span class="nf">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="nv">inDataCountDec</span><span class="o">.</span><span class="py">indices</span><span class="o">)</span> <span class="o">{</span>
		<span class="nf">println</span><span class="o">(</span><span class="nf">inDataCountDec</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
		<span class="nf">println</span><span class="o">(</span><span class="nf">inDataCountBinary</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>


                    </div>
                </div>
            </div>
            <footer class="unit-foot">
                <div class="unit-inner unit-foot-inner">
                    <div class="post-buttons">
                        <a class="internal gotop" href="#page" title="Back to Top">Back to Top</a>
                        
                    </div>
                    <nav class="pagination">
                        
                            <a class="internal" rel="prev" href="/blog/2020/01/12/2020-01-06-12-weekly-review/" title=" '2020/01/06-12 weekly review'"> ← 2020/01/06-12 weekly review</a>
                        
                        
                            <a class="internal" rel="next" href="/blog/2020/01/26/2020-01-20-26-weekly-review/" title="Next Post '2020/01/20-26 weekly review'">2020/01/20-26 weekly review → </a>
                        
                    </nav>
                </div>
            </footer>
            <div class="misc-content">
                
                
                    <div id="container"></div>
                    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
                    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
                    <script>
                    var gitment = new Gitment({
                      owner: "singularitykchen",
                      repo: "https://github.com/SingularityKChen/singularitykchen.github.io",
                      oauth: {
                        client_id: "d22349012c96f951207c",
                        client_secret: "843195c3b1f0b2f258f88684767445c2ceae1996",
                      },
                      labels: "2020/01/13-19 weekly review",
                    })
                    gitment.render('container')
                    </script>
                
            </div>
        </div>
    </div>
</article>

                    </div>
                </div>
            </div>
        </div>
        <footer class="the-footer">
    <div class="unit-foot">
        <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
                <div class="about">
                    <h4><a href="/">About</a></h4>
                    
                        <p>A gem-based responsive simple texture styled <a href="http://jekyllrb.com/">Jekyll</a> theme.</p>
                    
                    <p><small>Theme <a href="https://github.com/yizeng/jekyll-theme-simple-texture" target="_blank">Simple Texture</a> developed by <a href="https://yizeng.me" target="_blank">Yi Zeng</a>, powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>.</small></p>
                </div>
                <div class="social-links">
                    
                        <a class="ico-gmail" href="mailto:chency_singularity@163.com" rel="me" target="_blank" title="email"></a>
                    
                    <a class="ico-rss" href="/feed.xml" rel="me" target="_blank" title="feed"></a>
                    
                        
                            <a class="ico-github" href="https://github.com/SingularityKChen" rel="me" target="_blank" title="github"></a>
                        
                    
                        
                            <a class="ico-linkedin" href="https://www.linkedin.com/in/singularitykchen/" rel="me" target="_blank" title="linkedin"></a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                </div>
            </div>
        </div>
    </div>
    <a href="#" class="internal back-to-top">Back to Top</a>
</footer>

    </div>

    <script>
$(document).ready(function () {
    var offset = 50,
        duration = 500,
        width = 960;
    $(window).scroll(function () {
        if ($(window).width() > width) {
            if ($(this).scrollTop() > offset) {
                $('footer').css('top', '20px');
                $('footer .back-to-top').fadeIn(duration);
            } else {
                $('footer').css('top', 'auto');
                $('footer .back-to-top').fadeOut(duration);
            }
        }
    });
    $(window).resize(function () {
        if ($(window).width() < width) {
            $('footer').css('top', 'auto');
            $('footer .back-to-top').fadeOut(duration);
        }
        if ($(window).width() >= width && $(this).scrollTop() > offset) {
            $('footer').css('top', '20px');
            $('footer .back-to-top').fadeIn(duration);
        }
    });

    $('footer .back-to-top, .gotop').on('click', function (event) {
        event.preventDefault();
        $('html, body').animate({
            scrollTop: 0
        }, duration);
        return false;
    });

    $('.show-hidden').on('click', function () {
        $(this).parent().next().toggleClass("hidden");
        $(this).toggleClass("hidden");
    });
});
</script>

<!-- Show menu overlay + Jekyll Simple Search option -->
<script src="/assets/javascripts/jekyll-search.jquery.js"></script>
<script>
$(document).ready(function () {
    $('.search-field').simpleJekyllSearch({
      jsonFile: '/search.json',
      template: '<li><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></li>',
      searchResults: '.search-wrapper .results',
      searchResultsTitle: '<h4>Search results</h4>',
      noResults: '<p>Oh shucks<br/><small>Nothing found :(</small></p>'
    });
});

(function ($, window, undefined) {
    var closeOverlay = function () {
        $('.nav-wrapper, .search-wrapper').removeAttr('style');
        $(".nav-form, .search-form").removeClass('active');
        $("body").removeClass('nav-overlay search-overlay');
    };

    $('.nav-global .btn-search').on('click', function () {
        $('.search-wrapper').css({display: "block"});
        $(".search-form").addClass('active');
        $(".search-form").find('input').focus();
        $("body").addClass('search-overlay');
    });

    $('.nav-global .btn-menu').on('click', function () {
        $('.nav-wrapper').css({display: "block"});
        $(".nav-form").addClass('active');
        $(".nav-form .search-field").prop('disabled', true);
        $("body").addClass('nav-overlay');
    });

    $('.nav-wrapper .btn-close, .search-wrapper .btn-close').on('click', function () {
        closeOverlay();
    });

    $(document).on('keyup', function (e) {
        if (e.keyCode === 27) {
            closeOverlay();
        }
    });
})(jQuery, window);
</script>

<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-buttons.min.js'></script>
<script src="/assets/javascripts/unveil/jquery.unveil.min.js"></script>

<script>
    window.jQuery.fancybox || document.write('<script src="/assets/javascripts/fancybox/jquery.fancybox.pack.js?v=2.1.4"><\/script>')
    window.jQuery.fancybox.helpers.buttons || document.write('<script src="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"><\/script>')
</script>

<script>
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/jquery.fancybox.css?v=2.1.4" type="text/css" />');
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" />');
    $(".post-image").fancybox({
        prevEffect: 'none',
        nextEffect: 'none',
        closeBtn: true,
        helpers: {
            title: {
                type: 'float'
            }
        }
    });
    $(document).ready(function () {
        $(".post-image > img").unveil(450);
    });
</script>

</body>

</html>